srcdir		:= @srcdir@
VPATH		:= $(srcdir)

# for package builds (buildroot install + no root privs needed)
DESTDIR=
SUID_ROOT=-m4755 -o root

# install paths
prefix		:= @prefix@
exec_prefix	:= @exec_prefix@
bindir		:= $(DESTDIR)@bindir@
mandir		:= $(DESTDIR)@mandir@
libdir		:= $(DESTDIR)@libdir@/xawtv
resdir		:= $(DESTDIR)@resdir@
config		:= @x11conf@/xawtvrc

# programs
CC		:= @CC@
INSTALL		:= @INSTALL@
INSTALL_PROGRAM := @INSTALL_PROGRAM@ -s
INSTALL_DATA	:= @INSTALL_DATA@
INSTALL_DIR	:= @INSTALL@ -d -m 755

# misc
VERSION		:= @VERSION@

# for CFLAGS
WARN_FLAGS	:= -Wall -Wmissing-prototypes -Wstrict-prototypes -Wpointer-arith
LFS_FLAGS	:= -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64
X11_FLAGS	:= @X_CFLAGS@ -I/usr/X11R6/include/X11/fonts
LIB_FLAGS	:= -I. -I./vbistuff -I./x11 \
		   -I$(srcdir)/jwz -I$(srcdir)/common -I$(srcdir)/console \
		   -I$(srcdir)/libng -Llibng

# various libraries
ATHENA_LIBS	:= @X_LIBS@ @LIBS@ @ATHENA@
MOTIF_LIBS	:= @X_LIBS@ @LIBS@ -lXm -lXmu -lXt @X_PRE_LIBS@ \
		   -lXp -lXpm -lXext -lX11 @X_EXTRA_LIBS@
THREAD_LIBS	:= @LIBPTHREAD@
CURSES_LIBS	:= @LIBCURSES@
LIRC_LIBS	:= @LIRC@
OSS_LIBS	:= @LIBOSS@
ALSA_LIBS	:= @LIBALSA@
AA_LIBS		:= @AALIBS@
QT_LIBS		:= @QTLIBS@
VBI_LIBS	:= @LIBZVBI@ -lm
FS_LIBS		:= -L@x_libraries@ @FSLIB@
DLFLAGS		:= @DLFLAGS@

# stuff configure has found
FOUND_AALIB	:= @FOUND_AALIB@
FOUND_ALSA	:= @FOUND_ALSA@
FOUND_GL	:= @FOUND_GL@
FOUND_LQT	:= @FOUND_LQT@
FOUND_MOTIF	:= @FOUND_MOTIF@
FOUND_OS	:= @FOUND_OS@
FOUND_X11	:= @FOUND_X11@
FOUND_ZVBI	:= @FOUND_ZVBI@

# build final cflags
CFLAGS	:= @CFLAGS@
CFLAGS	+= $(WARN_FLAGS)
CFLAGS	+= $(LFS_FLAGS)
CFLAGS	+= $(X11_FLAGS)
CFLAGS	+= $(LIB_FLAGS)
CFLAGS	+= -DCONFIGFILE='"$(config)"'
CFLAGS	+= -DLIBDIR='"$(libdir)"'
CFLAGS	+= -DVERSION='"$(VERSION)"'

# shared objects need -fPIC
%.so : CFLAGS += -fPIC


#########################################################
# targets

build: all

Makefile: $(srcdir)/Makefile.in $(srcdir)/configure
	$(srcdir)/configure

install:: all
	$(INSTALL_DIR) $(bindir)

clean::
	find . -name \*~ -print | xargs rm -f
	find . -name \*.o -print | xargs rm -f
	find . -name \*.a -print | xargs rm -f
	find . -name \*.d -print | xargs rm -f
	find . -name \*.pic -print | xargs rm -f
	find . -name \*.dep -print | xargs rm -f

distclean:: clean
	-rm -f Makefile Make.config
	-rm -f config.cache config.h config.log config.status
	cp Makefile.clean Makefile

realclean:: distclean
	find . -name snap0*.ppm  -print | xargs -i rm -f
	find . -name snap0*.jpeg -print | xargs -i rm -f
	find . -name .nfs* -print | xargs -i rm -f
	find . -name core.* -print | xargs -i rm -f


#########################################################
# some rules ...

.SUFFIXES: .c .h .o .so .in .ad .bdf .pcf.gz

.c.o:
	$(CC) $(CFLAGS) -Wp,-MD,$*.dep -c -o $@ $<
	@sed -e "s|.*\.o:|$@::|" < $*.dep > $*.d && rm -f $*.dep

.o.so:
	$(CC) $(LDFLAGS) -shared -Wl,-soname,$@ -o $@ $< $(LDLIBS)

%: %.o
	$(CC) $(LDFLAGS) -o $@  $^ $(LDLIBS)

.in.h:
	perl -ne 's/\"/\\\"/g; chop; print "\"$$_\\n\"\n"' $< > $@

.ad.h:
	perl $(srcdir)/scripts/fallback.pl < $< > $@

.bdf.pcf.gz:
	bdftopcf -o $*.pcf $<
	gzip $*.pcf


#########################################################
# include stuff

# must come first
include $(srcdir)/common/Subdir.mk

# subdirs
include $(srcdir)/console/Subdir.mk
include $(srcdir)/debug/Subdir.mk
include $(srcdir)/libng/Subdir.mk
include $(srcdir)/libng/plugins/Subdir.mk
include $(srcdir)/man/Subdir.mk
include $(srcdir)/scripts/Subdir.mk
include $(srcdir)/vbistuff/Subdir.mk
include $(srcdir)/x11/Subdir.mk

# dependences
-include common/*.d
-include console/*.d
-include debug/*.d
-include jwz/*.d
-include libng/*.d
-include libng/plugins/*.d
-include vbistuff/*.d
-include x11/*.d


#########################################################
# just for me, some maintaining jobs.  Don't use them

checkit: distclean
	dpkg-buildpackage -tc -us -uc -rfakeroot
	lintian ../xawtv_*.changes

release: distclean
	dpkg-buildpackage -tc -rfakeroot

port:
	dpkg-buildpackage -b -tc -rfakeroot

tarball: distclean
	(cd ..; tar cvzf xawtv_$(VERSION).tar.gz \
		xawtv-$(VERSION))

rpm: tarball
	rpm -ta ../xawtv_$(VERSION).tar.gz

snapshot: distclean
	(cd ..; tar cvzf xawtv-snap-`date +%Y-%m-%d`.tar.gz \
		xawtv-$(VERSION))

auto: distclean
	rm -f config.cache
	autoconf
	autoheader
	./configure
	make
